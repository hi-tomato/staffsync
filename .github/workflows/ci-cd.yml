name: WorkHub CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "18"

jobs:
  quality-checks:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ” 1ë‹¨ê³„ - TypeScript íƒ€ì… ì²´í¬
        run: |
          echo "ğŸ” TypeScript íƒ€ì… ê²€ì‚¬ ì‹œì‘..."
          npm run type-check
          echo "âœ… íƒ€ì… ì²´í¬ ì™„ë£Œ!"

      - name: ğŸ§¹ 2ë‹¨ê³„ - ESLint ì½”ë“œ í’ˆì§ˆ ì²´í¬
        run: |
          echo "ğŸ§¹ ESLint ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘..."
          npm run lint
          echo "âœ… ë¦°íŠ¸ ì²´í¬ ì™„ë£Œ!"

      - name: ğŸ—ï¸ 3ë‹¨ê³„ - Next.js ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì‹œì‘..."
          npm run build
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"

      - name: ğŸ“Š ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: |
          if [ -d ".next" ]; then
            echo "âœ… .next í´ë” ìƒì„± í™•ì¸"
            echo "ğŸ“ ë¹Œë“œ ê²°ê³¼:"
            ls -la .next/
          else
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨ - .next í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

  deploy-preview:
    name: ğŸš€ ë¯¸ë¦¬ë³´ê¸° ë°°í¬ (PR)
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.event_name == 'pull_request'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Vercel ë¯¸ë¦¬ë³´ê¸° ë°°í¬
        uses: amondnet/vercel-action@v25
        id: vercel-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: "junis-projects-a9e38f6a"
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          github-comment: true

      - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë¯¸ë¦¬ë³´ê¸° ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ”— ë¯¸ë¦¬ë³´ê¸° URL: ${{ steps.vercel-preview.outputs.preview-url }}"

  deploy-production:
    name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ (Main)
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Vercel í”„ë¡œë•ì…˜ ë°°í¬
        uses: amondnet/vercel-action@v25
        id: vercel-production
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: "junis-projects-a9e38f6a"
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: "--prod"
          github-comment: true

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ë¼ì´ë¸Œ URL: ${{ steps.vercel-production.outputs.preview-url }}"
          echo "ğŸ“§ ë°°í¬ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”."

  notify-failure:
    name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [quality-checks, deploy-preview, deploy-production]
    if: failure()

    steps:
      - name: ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
        run: |
          echo "ğŸš¨ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!"
          echo "ğŸ” ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”:"
          echo "   - TypeScript ì»´íŒŒì¼ ì—ëŸ¬"
          echo "   - ESLint ê·œì¹™ ìœ„ë°˜"
          echo "   - ë¹Œë“œ ê³¼ì • ì—ëŸ¬"
          echo "   - í™˜ê²½ë³€ìˆ˜ ì„¤ì •"
